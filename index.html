<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在线代理检测工具</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // 禁用 Tailwind CDN 生产环境警告
    tailwind.config = {
      corePlugins: {
        preflight: true,
      }
    }
  </script>

  <!-- Vue 3 CDN (生产版本) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    /* 自定义滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Toast 动画样式 */
    .toast-enter-active, .toast-leave-active {
      transition: all 0.3s ease;
    }
    .toast-enter-from {
      opacity: 0;
      transform: translate(-50%, -20px);
    }
    .toast-leave-to {
      opacity: 0;
      transform: translate(-50%, -20px);
    }

    /* Loading 动画 */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    .loading-pulse {
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
  <div id="app" class="flex flex-col">
    <div class="container mx-auto px-4 py-6 flex flex-col">
      <!-- 标题 -->
      <div class="text-center mb-4 flex-shrink-0 relative">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">
          在线代理检测工具
        </h1>
        <!-- GitHub 链接 -->
        <a
          href="https://github.com/chaos-zhu/proxy-checker"
          target="_blank"
          rel="noopener noreferrer"
          class="absolute right-0 top-0 flex items-center gap-1.5 px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-white text-xs font-medium rounded-lg transition-all"
          title="GitHub 仓库"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          <span>GitHub</span>
        </a>
      </div>

      <!-- 主要输入区域 -->
      <div class="bg-white rounded-xl shadow-lg p-5 mb-4 flex-shrink-0">
        <!-- 配置区域 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-gray-700 text-sm font-semibold mb-2">代理类型</label>
            <select
              v-model="proxyType"
              @change="saveToLocalStorage"
              class="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            >
              <option value="http">HTTP</option>
              <option value="https">HTTPS</option>
              <option value="socks5">SOCKS5</option>
            </select>
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-semibold mb-2">超时（秒）</label>
            <input
              v-model.number="timeout"
              @input="saveToLocalStorage"
              type="number"
              min="1"
              max="60"
              class="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            />
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-semibold mb-2">输入模式</label>
            <div class="flex gap-2">
              <button
                @click="inputMode = 'direct'; saveToLocalStorage();"
                :class="['flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-all', inputMode === 'direct' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
              >
                直接输入
              </button>
              <button
                @click="inputMode = 'combine'; saveToLocalStorage();"
                :class="['flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-all', inputMode === 'combine' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
              >
                格式转换
              </button>
            </div>
          </div>
        </div>

        <!-- 直接输入模式 -->
        <div v-if="inputMode === 'direct'">
          <label class="block text-gray-700 text-sm font-semibold mb-2">
            代理列表（每行一个，格式：host:port:username:password）
          </label>
          <textarea
            v-model="proxyInput"
            @input="saveToLocalStorage"
            class="w-full h-36 max-h-96 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm transition-all resize-y"
            placeholder="xxx.com:55688:username:tessfdpass&#x0a;xxx2.com:55288:username:tessfdpass2&#x0a;"
          ></textarea>

          <!-- 操作按钮 -->
          <div class="flex gap-2 mt-3">
            <button
              @click="checkProxies"
              :disabled="isChecking || !proxyInput.trim()"
              class="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-blue-800 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
            >
              <svg v-if="isChecking" class="w-4 h-4 loading-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span>{{ isChecking ? '检测中' : '开始检测' }}</span>
            </button>
            <button
              @click="isChecking ? stopChecking() : clearAll()"
              class="flex-1 px-4 py-2.5 text-white text-sm font-medium rounded-lg transition-all shadow-md hover:shadow-lg"
              :class="isChecking ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 hover:bg-gray-700'"
            >
              {{ isChecking ? '停止' : '清空' }}
            </button>
          </div>
        </div>

        <!-- 格式转换模式 -->
        <div v-if="inputMode === 'combine'">
          <div class="space-y-4">
            <!-- 格式配置 -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-gray-800">格式配置</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-gray-700 text-xs font-medium mb-1.5">原始分隔符</label>
                  <input
                    v-model="customSeparator"
                    @input="saveToLocalStorage"
                    type="text"
                    class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    placeholder="例如：: 或 | 或 , 等"
                  />
                </div>
                <div>
                  <label class="block text-gray-700 text-xs font-medium mb-1.5">字段顺序（用逗号分隔）</label>
                  <input
                    v-model="fieldOrder"
                    @input="saveToLocalStorage"
                    type="text"
                    class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    placeholder="例如：host,port,username,password"
                  />
                </div>
              </div>
              <div class="text-xs text-gray-600 mt-2 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                支持字段：host, port, username, password（顺序可自定义）
              </div>
            </div>

            <!-- 代理输入 -->
            <div>
              <label class="block text-gray-700 text-sm font-semibold mb-2">原始代理列表</label>
              <textarea
                v-model="combineProxyList"
                @input="saveToLocalStorage"
                class="w-full h-28 max-h-80 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm transition-all resize-y"
                placeholder="按照你的格式输入，例如：&#x0a;us.proxy.net|55688|password123|user456&#x0a;或&#x0a;us.proxy.net:55688:password123:user456"
              ></textarea>
            </div>

            <!-- 转换按钮和结果 -->
            <div class="flex items-center gap-3">
              <button
                @click="convertProxies"
                class="px-5 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white text-sm font-medium rounded-lg hover:from-green-700 hover:to-green-800 transition-all shadow-md hover:shadow-lg"
              >
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  转换为标准格式
                </span>
              </button>
              <span v-if="combinedResult" class="text-sm text-gray-600 flex items-center gap-1">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                已转换 {{ combinedResultCount }} 个代理
              </span>
            </div>

            <!-- 转换结果预览 -->
            <div v-if="combinedResult">
              <label class="block text-gray-700 text-sm font-semibold mb-2">
                转换结果（标准格式：host:port:username:password）
              </label>
              <textarea
                v-model="combinedResult"
                readonly
                class="w-full h-24 max-h-64 p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm resize-y"
              ></textarea>
            </div>

            <!-- 操作按钮 -->
            <div class="flex gap-2">
              <button
                @click="checkProxies"
                :disabled="isChecking || !proxyInput.trim()"
                class="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-blue-800 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
              >
                <svg v-if="isChecking" class="w-4 h-4 loading-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>{{ isChecking ? '检测中' : '开始检测' }}</span>
              </button>
              <button
                @click="isChecking ? stopChecking() : clearAll()"
                class="flex-1 px-4 py-2.5 text-white text-sm font-medium rounded-lg transition-all shadow-md hover:shadow-lg"
                :class="isChecking ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 hover:bg-gray-700'"
              >
                {{ isChecking ? '停止' : '清空' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 结果显示 -->
      <div v-if="results.length > 0" class="bg-white rounded-xl shadow-lg p-5 mt-4 flex flex-col">
        <!-- 标题和统计信息 -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4 flex-shrink-0">
          <h2 class="text-xl font-bold text-gray-800">检测结果</h2>

          <!-- 统计信息 -->
          <div class="flex flex-wrap gap-3">
            <div class="text-center px-3 py-1.5 bg-gray-50 rounded-lg">
              <div class="text-xs text-gray-600">总数</div>
              <div class="text-lg font-bold text-gray-800">{{ totalCount }}</div>
            </div>
            <div class="text-center px-3 py-1.5 bg-green-50 rounded-lg">
              <div class="text-xs text-gray-600">成功</div>
              <div class="text-lg font-bold text-green-600">{{ successCount }}</div>
            </div>
            <div class="text-center px-3 py-1.5 bg-red-50 rounded-lg">
              <div class="text-xs text-gray-600">失败</div>
              <div class="text-lg font-bold text-red-600">{{ failedCount }}</div>
            </div>
            <div class="text-center px-3 py-1.5 bg-blue-50 rounded-lg">
              <div class="text-xs text-gray-600">成功率</div>
              <div class="text-lg font-bold text-blue-600">{{ successRate }}%</div>
            </div>
          </div>
        </div>

        <!-- 进度条 -->
        <div v-if="isChecking" class="mb-4 flex-shrink-0">
          <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 loading-spinner text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span class="loading-pulse font-medium">检测中</span>
            </div>
            <span class="font-semibold text-blue-600">{{ results.length }}/{{ totalCount }} ({{ progressPercentage }}%)</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden shadow-inner">
            <div
              class="bg-gradient-to-r from-blue-500 via-blue-600 to-blue-500 h-2.5 rounded-full transition-all duration-300 relative overflow-hidden"
              :style="{ width: progressPercentage + '%' }"
            >
              <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 loading-pulse"></div>
            </div>
          </div>
        </div>

        <!-- 过滤和操作按钮 -->
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
          <div class="flex gap-2 flex-wrap">
            <!-- 过滤按钮 -->
            <button
              @click="filter = 'all'"
              :class="['px-3 py-1.5 rounded-lg text-xs font-medium transition-all', filter === 'all' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
            >
              全部 {{ results.length }}
            </button>
            <button
              @click="filter = 'success'"
              :class="['px-3 py-1.5 rounded-lg text-xs font-medium transition-all', filter === 'success' ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
            >
              成功 {{ successCount }}
            </button>
            <button
              @click="filter = 'failed'"
              :class="['px-3 py-1.5 rounded-lg text-xs font-medium transition-all', filter === 'failed' ? 'bg-red-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
            >
              失败 {{ failedCount }}
            </button>
            <button
              @click="copySuccessful"
              :disabled="successCount === 0"
              class="px-3 py-1.5 bg-gradient-to-r from-green-600 to-green-700 text-white text-xs font-medium rounded-lg hover:from-green-700 hover:to-green-800 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center gap-1"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              复制成功
            </button>
            <button
              @click="copyFailed"
              :disabled="failedCount === 0"
              class="px-3 py-1.5 bg-gradient-to-r from-red-600 to-red-700 text-white text-xs font-medium rounded-lg hover:from-red-700 hover:to-red-800 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center gap-1"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              复制失败
            </button>
          </div>
        </div>

        <!-- 结果列表 -->
        <div ref="resultsList" class="space-y-2 max-h-[600px] overflow-y-auto pr-2" @scroll="handleScroll">
          <div
            v-for="(result, index) in filteredResults"
            :key="index"
            class="border rounded-lg p-2.5 transition-all hover:shadow-md"
            :class="{
              'border-green-200 bg-green-50 hover:border-green-300': result.status === 'success',
              'border-red-200 bg-red-50 hover:border-red-300': result.status === 'failed',
              'border-yellow-200 bg-yellow-50 hover:border-yellow-300': result.status === 'invalid'
            }"
          >
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <!-- 第一行：状态、响应时间、代理类型 -->
                <div class="flex items-center gap-2 mb-1.5">
                  <span
                    class="px-2 py-0.5 rounded text-xs font-semibold"
                    :class="{
                      'bg-green-600 text-white': result.status === 'success',
                      'bg-red-600 text-white': result.status === 'failed',
                      'bg-yellow-600 text-white': result.status === 'invalid'
                    }"
                  >
                    {{ result.status === 'success' ? '成功' : result.status === 'failed' ? '失败' : '无效' }}
                  </span>
                  <span class="text-gray-600 text-xs">{{ result.responseTime }}ms</span>
                  <span v-if="result.proxyType" class="px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">
                    {{ result.proxyType.toUpperCase() }}
                  </span>
                </div>
                <!-- 第二行：代理地址 -->
                <div class="font-mono text-sm text-gray-800 mb-1 break-all leading-tight">
                  {{ result.proxy }}
                </div>
                <!-- 第三行：IP信息或错误信息 -->
                <div class="text-xs text-gray-600">
                  <span v-if="result.status === 'success'" class="flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    {{ result.ip }} | {{ result.country }} - {{ result.city }}
                  </span>
                  <span v-else>{{ result.message }}</span>
                </div>
              </div>
              <!-- 复制按钮 -->
              <button
                @click="copyProxy(result.proxy)"
                class="flex-shrink-0 p-1.5 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all"
                title="复制代理"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast 提示组件 -->
    <transition name="toast">
      <div
        v-if="toast.show"
        class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 max-w-md"
        :class="{
          'bg-green-500 text-white': toast.type === 'success',
          'bg-red-500 text-white': toast.type === 'error',
          'bg-blue-500 text-white': toast.type === 'info'
        }"
      >
        <svg v-if="toast.type === 'success'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <svg v-if="toast.type === 'error'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <svg v-if="toast.type === 'info'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>{{ toast.message }}</span>
      </div>
    </transition>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          proxyInput: '',
          results: [],
          isChecking: false,
          filter: 'all',
          proxyType: 'http',
          timeout: 3,
          totalCount: 0,
          inputMode: 'direct',
          combineProxyList: '',
          customSeparator: ':',
          fieldOrder: 'host,port,username,password',
          combinedResult: '',
          toast: {
            show: false,
            message: '',
            type: 'success' // success, error, info
          },
          shouldAutoScroll: true, // 是否自动滚动到底部
          abortController: null // 用于中止检测的控制器
        };
      },
      computed: {
        successCount() {
          return this.results.filter(r => r.status === 'success').length;
        },
        failedCount() {
          return this.results.filter(r => r.status === 'failed' || r.status === 'invalid').length;
        },
        successRate() {
          if (this.totalCount === 0) return 0;
          return Math.round((this.successCount / this.totalCount) * 100);
        },
        progressPercentage() {
          if (this.totalCount === 0) return 0;
          return Math.round((this.results.length / this.totalCount) * 100);
        },
        filteredResults() {
          if (this.filter === 'all') {
            return this.results;
          } else if (this.filter === 'success') {
            return this.results.filter(r => r.status === 'success');
          } else {
            return this.results.filter(r => r.status === 'failed' || r.status === 'invalid');
          }
        },
        combinedResultCount() {
          if (!this.combinedResult) return 0;
          return this.combinedResult.split('\n').filter(line => line.trim()).length;
        }
      },
      mounted() {
        this.loadFromLocalStorage();
      },
      watch: {
        results: {
          handler() {
            // 当results更新时，如果应该自动滚动，则滚动到底部
            if (this.shouldAutoScroll) {
              this.$nextTick(() => {
                this.scrollToBottom();
              });
            }
          },
          deep: true
        }
      },
      methods: {
        handleScroll(event) {
          const element = event.target;
          const threshold = 50; // 距离底部50px以内认为是在底部
          const isAtBottom = element.scrollHeight - element.scrollTop - element.clientHeight <= threshold;

          // 更新是否应该自动滚动的标志
          this.shouldAutoScroll = isAtBottom;
        },

        scrollToBottom() {
          const resultsList = this.$refs.resultsList;
          if (resultsList) {
            resultsList.scrollTo({
              top: resultsList.scrollHeight,
              behavior: 'smooth'
            });
          }
        },

        showToast(message, type = 'success') {
          this.toast.message = message;
          this.toast.type = type;
          this.toast.show = true;

          setTimeout(() => {
            this.toast.show = false;
          }, 3000);
        },

        async copyProxy(proxy) {
          try {
            await navigator.clipboard.writeText(proxy);
            this.showToast('已复制到剪贴板', 'success');
          } catch (err) {
            this.showToast('复制失败：' + err.message, 'error');
          }
        },

        saveToLocalStorage() {
          const data = {
            proxyInput: this.proxyInput,
            proxyType: this.proxyType,
            timeout: this.timeout,
            inputMode: this.inputMode,
            combineProxyList: this.combineProxyList,
            customSeparator: this.customSeparator,
            fieldOrder: this.fieldOrder,
          };
          localStorage.setItem('proxyCheckerData', JSON.stringify(data));
        },

        loadFromLocalStorage() {
          const savedData = localStorage.getItem('proxyCheckerData');
          if (savedData) {
            try {
              const data = JSON.parse(savedData);
              this.proxyInput = data.proxyInput || '';
              this.proxyType = data.proxyType || 'http';
              this.timeout = data.timeout || 3;
              this.inputMode = data.inputMode || 'direct';
              this.combineProxyList = data.combineProxyList || '';
              this.customSeparator = data.customSeparator || ':';
              this.fieldOrder = data.fieldOrder || 'host,port,username,password';
            } catch (e) {
              console.error('加载缓存数据失败:', e);
            }
          }
        },

        convertProxies() {
          const lines = this.combineProxyList
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);

          if (lines.length === 0) {
            this.showToast('请输入代理列表', 'error');
            return;
          }

          if (!this.customSeparator) {
            this.showToast('请输入分隔符', 'error');
            return;
          }

          const fields = this.fieldOrder.split(',').map(f => f.trim().toLowerCase());
          const validFields = ['host', 'port', 'username', 'password'];

          for (const field of fields) {
            if (!validFields.includes(field)) {
              this.showToast(`无效的字段名：${field}。支持的字段：host, port, username, password`, 'error');
              return;
            }
          }

          const converted = lines.map(line => {
            const parts = line.split(this.customSeparator);

            if (parts.length !== fields.length) {
              console.warn(`格式不匹配：${line}，期望 ${fields.length} 个字段，实际 ${parts.length} 个`);
              return null;
            }

            const fieldMap = {};
            fields.forEach((field, index) => {
              fieldMap[field] = parts[index];
            });

            return `${fieldMap.host || ''}:${fieldMap.port || ''}:${fieldMap.username || ''}:${fieldMap.password || ''}`;
          }).filter(line => line !== null);

          if (converted.length === 0) {
            this.showToast('没有成功转换的代理', 'error');
            return;
          }

          this.combinedResult = converted.join('\n');
          this.proxyInput = this.combinedResult;
          this.saveToLocalStorage();
          this.showToast(`成功转换 ${converted.length} 个代理`, 'success');
        },

        async checkProxies() {
          const proxies = this.proxyInput
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);

          if (proxies.length === 0) {
            this.showToast('请输入至少一个代理', 'error');
            return;
          }

          // 开始新检测时清空旧结果
          this.isChecking = true;
          this.results = [];
          this.totalCount = proxies.length;
          this.shouldAutoScroll = true; // 重置自动滚动标志

          // 创建新的 AbortController
          this.abortController = new AbortController();

          try {
            const response = await fetch('/api/check-proxies-stream', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                proxies,
                proxyType: this.proxyType,
                timeout: this.timeout * 1000
              }),
              signal: this.abortController.signal
            });

            if (!response.ok) {
              throw new Error('请求失败');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
              const { done, value } = await reader.read();

              if (done) break;

              buffer += decoder.decode(value, { stream: true });

              const lines = buffer.split('\n\n');
              buffer = lines.pop();

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);

                  if (data === '[DONE]') {
                    break;
                  }

                  try {
                    const result = JSON.parse(data);
                    this.results.push(result);
                  } catch (e) {
                    console.error('解析数据失败:', e);
                  }
                }
              }
            }

          } catch (error) {
            if (error.name === 'AbortError') {
              this.showToast('检测已停止', 'info');
            } else {
              this.showToast('检测失败：' + error.message, 'error');
            }
          } finally {
            this.isChecking = false;
            this.abortController = null;
          }
        },

        stopChecking() {
          if (this.abortController) {
            this.abortController.abort();
            this.abortController = null;
          }
          this.isChecking = false;
        },

        clearAll() {
          if (confirm('确定要清空所有数据吗？这将清除缓存的代理列表和配置。')) {
            this.proxyInput = '';
            this.results = [];
            this.totalCount = 0;
            this.filter = 'all';
            this.combineProxyList = '';
            this.customSeparator = ':';
            this.fieldOrder = 'host,port,username,password';
            this.combinedResult = '';

            localStorage.removeItem('proxyCheckerData');
          }
        },

        async copySuccessful() {
          const successfulProxies = this.results
            .filter(r => r.status === 'success')
            .map(r => r.proxy)
            .join('\n');

          try {
            await navigator.clipboard.writeText(successfulProxies);
            this.showToast(`已复制 ${this.successCount} 个成功的代理`, 'success');
          } catch (err) {
            this.showToast('复制失败：' + err.message, 'error');
          }
        },

        async copyFailed() {
          const failedProxies = this.results
            .filter(r => r.status === 'failed' || r.status === 'invalid')
            .map(r => r.proxy)
            .join('\n');

          try {
            await navigator.clipboard.writeText(failedProxies);
            this.showToast(`已复制 ${this.failedCount} 个失败的代理`, 'success');
          } catch (err) {
            this.showToast('复制失败：' + err.message, 'error');
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
